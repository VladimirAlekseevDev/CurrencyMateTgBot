name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v3

      # Setup Google Cloud SDK
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # Auth to Google Artifact Registry
      - name: Authenticate Docker with Google Cloud
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      # Build Docker Image
      - name: Build Docker Image
        run: docker build -t us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/currency-mate-docker-images/currency-mate-tgbot:latest .

      # Push Docker Image to Google Artifact Registry
      - name: Push Docker Image to Google Cloud Artifact Registry
        run: docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/currency-mate-docker-images//currency-mate-tgbot:latest

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v3

      # Run Tests
      - name: Run Tests
        run: ./gradlew test

  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: test
    steps:
      # Checkout
      - name: Checkout repository
        uses: actions/checkout@v3

      # Setup Google Cloud SDK
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # Setup `kubectl`
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      # Auth to Kubernetes through Google Cloud
      - name: Authenticate with Google Cloud Kubernetes
        run: gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} --region ${{ secrets.GKE_CLUSTER_REGION }}

      # Restart Deployment
      - name: Restart Deployment
        run: kubectl rollout restart deployment currency-mate-deployment -n currency-mate-namespace